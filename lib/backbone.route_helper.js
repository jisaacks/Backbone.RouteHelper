// Generated by CoffeeScript 1.5.0
(function() {
  var namesPattern, optionalNamesPattern, optionalParam, origRouteMethod, originalLoadUrlMethod,
    __slice = [].slice;

  optionalParam = /\((.*?)\)/g;

  namesPattern = /[\:\*]([^\:\?\/\)]+)/g;

  optionalNamesPattern = /\(\/[^\:\?\/\)]*[\:\*]([^\:\?\/]+)\)/g;

  origRouteMethod = Backbone.Router.prototype.route;

  Backbone.Router.prototype.route = function(route, name, callback) {
    var k, template, _i, _len, _ref;
    if (_.isRegExp(route)) {
      _ref = ["template", "name", "allParamNames", "optionalParamNames"];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        k = _ref[_i];
        if (route[k] == null) {
          route[k] = null;
        }
      }
    } else {
      template = route;
      route = this._routeToRegExp(route);
      route.template = template;
      route.optionalParamNames = _.map(template.match(optionalParam), function(opt) {
        return opt.replace(optionalNamesPattern, "$1");
      });
      route.allParamNames = _.map(template.match(namesPattern), function(n) {
        return n.substring(1);
      });
      if (typeof name !== "function") {
        route.name = name;
      }
      route.helperId = this.routeHelperId;
      route.routerClass = this.constructor.name;
    }
    return origRouteMethod.apply(this, [route, name, callback]);
  };

  originalLoadUrlMethod = Backbone.History.prototype.loadUrl;

  Backbone.History.prototype.loadUrl = function(fragmentOverride) {
    var fragment, handler, helper, params, query, route;
    fragment = this.getFragment(fragmentOverride);
    handler = _.find(this.handlers, function(handler) {
      return handler.route.test(fragment);
    });
    route = handler.route;
    params = Backbone.Router.prototype._extractParameters(route, fragment);
    query = params.pop();
    params = _.object(route.allParamNames, params);
    helper = Backbone.RouteHelper.fromRoute(route);
    helper.build().params(params);
    if (query) {
      helper.query(query);
      helper._useQuery = false;
    }
    this.__currentRouteHelper = helper;
    return originalLoadUrlMethod.apply(this, [fragmentOverride]);
  };

  Backbone.RouteHelper = (function() {

    RouteHelper.current = function() {
      return Backbone.history.__currentRouteHelper.clone();
    };

    RouteHelper.modify = function(name) {
      if (name == null) {
        name = null;
      }
      return this.current().modify(name);
    };

    RouteHelper.route = function() {
      return this.current().modify().query().route();
    };

    RouteHelper.build = function(name) {
      var rh;
      if (name == null) {
        name = null;
      }
      name || (name = RouteHelper.current()._options.route.name);
      rh = new RouteHelper(name);
      rh.build();
      return rh;
    };

    RouteHelper.routeName = function(route) {
      var prefix;
      prefix = route.helperId || route.routerClass;
      return "" + prefix + ":" + route.name;
    };

    RouteHelper.fromRoute = function(route) {
      return new RouteHelper(this.routeName(route));
    };

    function RouteHelper(routeName) {
      this._options = {};
      this._options.route = this._getRouteByName(routeName);
      this._options.params = {};
      this._options.query = {};
      this._useQuery = false;
    }

    RouteHelper.prototype.route = function() {
      var _rt;
      _rt = this._buildRoute(this._options.route, this._options.params);
      if (_.values(this._options.query || {}).length && this._useQuery) {
        _rt = this._attachQuery(_rt, this._options.query);
      }
      return _rt;
    };

    RouteHelper.prototype.navigate = function(options) {
      return Backbone.history.navigate(this.route(), options);
    };

    RouteHelper.prototype.build = function(name) {
      if (name == null) {
        name = null;
      }
      if (name) {
        this._options.route = this._getRouteByName(name);
      }
      this._buildType = "build";
      return this;
    };

    RouteHelper.prototype.modify = function(name) {
      if (name == null) {
        name = null;
      }
      if (name) {
        this._options.route = this._getRouteByName(name);
      }
      this._buildType = "modify";
      return this;
    };

    RouteHelper.prototype.params = function(args) {
      switch (this._buildType) {
        case "build":
          this._options.params = args;
          break;
        case "modify":
          _.extend(this._options.params, args);
      }
      return this;
    };

    RouteHelper.prototype.query = function(args) {
      var _this = this;
      this._useQuery = true;
      if (typeof args === "string") {
        args = this._parseQuery(args);
      }
      switch (this._buildType) {
        case "build":
          this._options.query = args;
          break;
        case "modify":
          _.extend(this._options.query, args);
      }
      _.each(this._options.query, function(v, k) {
        if (v === void 0 || v === "") {
          return delete _this._options.query[k];
        }
      });
      return this;
    };

    RouteHelper.prototype.clone = function() {
      var _clone;
      _clone = RouteHelper.fromRoute(this._options.route);
      _clone._options.params = _.clone(this._options.params);
      if (this._options.query) {
        _clone._options.query = _.clone(this._options.query);
      }
      if (this._buildRoute === "modify") {
        _clone.modify();
      } else {
        _clone.build();
      }
      return _clone;
    };

    RouteHelper.prototype._attachQuery = function(route, query) {
      return route + "?" + this._buildQuery(query);
    };

    RouteHelper.prototype._getRouteByName = function(name) {
      var handler;
      handler = _.find(Backbone.history.handlers, function(handler) {
        return handler.route.name === name;
      });
      if (!handler) {
        handler = _.find(Backbone.history.handlers, function(handler) {
          return name === ("" + handler.route.helperId + ":" + handler.route.name);
        });
      }
      if (!handler) {
        handler = _.find(Backbone.history.handlers, function(handler) {
          return name === ("" + handler.route.routerClass + ":" + handler.route.name);
        });
      }
      if (!handler) {
        throw "No route found for " + name;
      }
      return handler.route;
    };

    RouteHelper.prototype._parseQuery = function(str) {
      return qs.parse(str);
    };

    RouteHelper.prototype._buildQuery = function(obj) {
      return qs.stringify(obj);
    };

    RouteHelper.prototype._buildRoute = function(route, args) {
      var allKeys, hasKeys, misKeys, optKeys, reqKeys, template,
        _this = this;
      template = route.template;
      if (template == null) {
        throw "No template found for " + route;
      }
      hasKeys = _.keys(args);
      allKeys = route.allParamNames;
      optKeys = route.optionalParamNames;
      reqKeys = _.without.apply(_, [allKeys].concat(__slice.call(optKeys)));
      misKeys = _.without.apply(_, [reqKeys].concat(__slice.call(hasKeys)));
      if (misKeys.length) {
        throw "Missing required params: " + (misKeys.join(', ')) + " for " + route.name;
      }
      _.each(reqKeys, function(key) {
        var re, val;
        val = args[key];
        re = new RegExp("(^|\/)(:|\\*)(" + key + ")");
        return template = template.replace(re, "$1" + val);
      });
      _.each(optKeys, function(key) {
        var re, val;
        val = args[key];
        if (val) {
          re = new RegExp("\\(\/([^\:\?\/\)]*):" + key + "\\)");
          return template = template.replace(re, "/$1" + val);
        }
      });
      template = template.replace(optionalParam, '');
      return template;
    };

    return RouteHelper;

  })();

}).call(this);
